<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BioCare Health Assessment System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap">
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/FXAAShader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

  <style>
    /* Custom Science/Medical Theme */
    :root {
      --primary: #3b82f6; /* [cite: 1] */
      --primary-hover: #2563eb; /* [cite: 2] */
      --secondary: #10B981; /* [cite: 2] */
      --accent: #06B6D4; /* [cite: 2] */
      --dark-bg: #1e293b; /* [cite: 2] */
      --panel-bg: #0f172a; /* [cite: 2] */
      --text-primary: #F9FAFB; /* [cite: 2] */
      --text-secondary: #D1D5DB; /* [cite: 2] */
      --glow-primary: 0 0 15px rgba(59, 130, 246, 0.5); /* [cite: 3] */
      --glow-secondary: 0 0 15px rgba(16, 185, 129, 0.5); /* [cite: 3] */
    }
    body {
      font-family: 'Roboto', sans-serif; /* [cite: 4] */
      margin: 0; /* [cite: 4] */
      overflow: hidden; /* [cite: 4] */
      background-color: var(--dark-bg); /* [cite: 4] */
      color: var(--text-primary); /* [cite: 4] */
    }
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Rajdhani', sans-serif; /* [cite: 5] */
      font-weight: 600; /* [cite: 5] */
    }
    .sci-panel {
      background-color: rgba(15, 23, 42, 0.85); /* [cite: 6] */
      backdrop-filter: blur(10px); /* [cite: 6] */
      border: 1px solid rgba(59, 130, 246, 0.2); /* [cite: 6] */
      border-radius: 0.5rem; /* [cite: 6] */
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), var(--glow-primary); /* [cite: 7] */
    }
    .sci-title {
      position: relative; /* [cite: 8] */
      overflow: hidden; /* [cite: 8] */
    }
    .sci-title::before {
      content: ''; /* [cite: 8] */
      position: absolute; /* [cite: 8] */
      top: 0; /* [cite: 8] */
      left: 0; /* [cite: 8] */
      width: 5px; /* [cite: 8] */
      height: 100%; /* [cite: 9] */
      background: linear-gradient(180deg, var(--primary), var(--secondary)); /* [cite: 9] */
    }
    .sci-badge {
      background: linear-gradient(45deg, var(--primary), var(--accent)); /* [cite: 9] */
      color: white; /* [cite: 9] */
      padding: 0.25rem 0.75rem; /* [cite: 9] */
      border-radius: 9999px; /* [cite: 9] */
      font-size: 0.75rem; /* [cite: 10] */
      font-weight: 500; /* [cite: 10] */
    }
    .sci-highlight {
      color: var(--secondary); /* [cite: 10] */
      font-weight: 500; /* [cite: 10] */
    }
    .glow-text {
      text-shadow: 0 0 8px rgba(59, 130, 246, 0.6); /* [cite: 11] */
    }
    /* Canvas Styling */
    #canvas-container {
      flex-grow: 1; /* [cite: 11] */
      height: 100vh; /* [cite: 12] */
      position: relative; /* [cite: 12] */
    }
    #canvas-container canvas {
      display: block; /* [cite: 12] */
      width: 100%; /* [cite: 12] */
      height: 100%; /* [cite: 12] */
      cursor: grab; /* [cite: 12] */
    }
    #canvas-container canvas:active {
      cursor: grabbing; /* [cite: 13] */
    }
    /* Sidebar Panel */
    #info-panel {
      width: 375px; /* [cite: 13] */
      height: 100vh; /* [cite: 13] */
      overflow-y: auto; /* [cite: 13] */
      flex-shrink: 0; /* [cite: 14] */
      background-color: var(--panel-bg); /* [cite: 14] */
      transition: transform 0.3s ease; /* [cite: 14] */
      scrollbar-width: thin; /* [cite: 14] */
      scrollbar-color: var(--primary) var(--panel-bg); /* [cite: 14] */
    }
    #info-panel::-webkit-scrollbar {
      width: 8px; /* [cite: 14] */
    }
    #info-panel::-webkit-scrollbar-track {
      background: var(--panel-bg); /* [cite: 15] */
    }
    #info-panel::-webkit-scrollbar-thumb {
      background-color: var(--primary); /* [cite: 15] */
      border-radius: 20px; /* [cite: 15] */
    }
    /* Loading Overlay */
    #loading-overlay {
      position: fixed; /* [cite: 16] */
      top: 0; /* [cite: 16] */
      left: 0; /* [cite: 16] */
      right: 0; /* [cite: 16] */
      bottom: 0; /* [cite: 16] */
      background-color: rgba(15, 23, 42, 0.95); /* [cite: 17] */
      display: flex; /* [cite: 17] */
      flex-direction: column; /* [cite: 17] */
      justify-content: center; /* [cite: 17] */
      align-items: center; /* [cite: 17] */
      z-index: 50; /* [cite: 17] */
    }
    .progress-bar {
      width: 300px; /* [cite: 17] */
      height: 8px; /* [cite: 18] */
      background-color: rgba(255, 255, 255, 0.1); /* [cite: 18] */
      border-radius: 4px; /* [cite: 18] */
      overflow: hidden; /* [cite: 18] */
      margin-top: 2rem; /* [cite: 18] */
    }
    .progress-fill {
      height: 100%; /* [cite: 18] */
      background: linear-gradient(90deg, var(--primary), var(--secondary)); /* [cite: 19] */
      width: 0%; /* [cite: 19] */
      transition: width 0.3s ease; /* [cite: 19] */
      box-shadow: var(--glow-primary); /* [cite: 19] */
    }
    /* Controls Guide */
    #controls-guide {
      position: absolute; /* [cite: 20] */
      bottom: 1rem; /* [cite: 20] */
      right: 1rem; /* [cite: 20] */
      background-color: rgba(15, 23, 42, 0.8); /* [cite: 20] */
      color: white; /* [cite: 20] */
      font-size: 0.75rem; /* [cite: 21] */
      line-height: 1.25rem; /* [cite: 21] */
      padding: 0.75rem; /* [cite: 21] */
      border-radius: 0.5rem; /* [cite: 21] */
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* [cite: 21] */
      z-index: 10; /* [cite: 22] */
      max-width: 250px; /* [cite: 22] */
      backdrop-filter: blur(8px); /* [cite: 22] */
      border: 1px solid rgba(59, 130, 246, 0.15); /* [cite: 22] */
      transition: opacity 0.3s; /* [cite: 22] */
      opacity: 0.7; /* [cite: 22] */
    }
    #controls-guide:hover {
      opacity: 1; /* [cite: 23] */
    }
    /* HUD Elements */
    .hud-element {
      position: absolute; /* [cite: 23] */
      pointer-events: none; /* [cite: 23] */
      z-index: 5; /* [cite: 23] */
      font-family: 'Rajdhani', sans-serif; /* [cite: 24] */
    }
    .body-stat {
      top: 1rem; /* [cite: 24] */
      left: 1rem; /* [cite: 24] */
      font-size: 0.8rem; /* [cite: 24] */
      padding: 0.75rem; /* [cite: 24] */
      color: var(--text-secondary); /* [cite: 24] */
      max-width: 250px; /* [cite: 24] */
    }
    .body-scan-line {
      position: absolute; /* [cite: 25] */
      width: 100%; /* [cite: 25] */
      height: 4px; /* [cite: 25] */
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.5), rgba(59, 130, 246, 0.2), transparent); /* [cite: 25] */
      z-index: 10; /* [cite: 26] */
      pointer-events: none; /* [cite: 26] */
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); /* [cite: 26] */
      opacity: 0; /* [cite: 26] */
      animation: scanAnimation 8s infinite; /* [cite: 26] */
    }
    @keyframes scanAnimation {
      0% { top: 0%; opacity: 1; } /* [cite: 27] */
      90% { top: 100%; opacity: 1; } /* [cite: 27] */
      91% { opacity: 0; } /* [cite: 28] */
      100% { top: 0%; opacity: 0; } /* [cite: 28] */
    }
    /* HUD Trackers */
    .tracker {
      position: absolute; /* [cite: 29] */
      width: 80px; /* [cite: 29] */
      height: 80px; /* [cite: 29] */
      pointer-events: none; /* [cite: 29] */
      z-index: 5; /* [cite: 29] */
      border: 1px solid rgba(59, 130, 246, 0.5); /* [cite: 30] */
      border-radius: 50%; /* [cite: 30] */
      transform: translate(-50%, -50%); /* [cite: 30] */
      background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, rgba(16, 185, 129, 0.05) 70%, transparent 100%); /* [cite: 31] */
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); /* [cite: 32] */
      opacity: 0; /* [cite: 32] */
      transition: opacity 0.5s; /* [cite: 32] */
    }
    .tracker::before, .tracker::after {
      content: ''; /* [cite: 32] */
      position: absolute; /* [cite: 33] */
      top: 50%; /* [cite: 33] */
      left: 50%; /* [cite: 33] */
      transform: translate(-50%, -50%); /* [cite: 33] */
      border-radius: 50%; /* [cite: 33] */
    }
    .tracker::before {
      width: 60px; /* [cite: 33] */
      height: 60px; /* [cite: 33] */
      border: 1px dashed rgba(59, 130, 246, 0.5); /* [cite: 34] */
      animation: rotate 10s linear infinite; /* [cite: 34] */
    }
    .tracker::after {
      width: 10px; /* [cite: 34] */
      height: 10px; /* [cite: 34] */
      background-color: rgba(16, 185, 129, 0.8); /* [cite: 35] */
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.8); /* [cite: 35] */
    }
    @keyframes rotate {
      from { transform: translate(-50%, -50%) rotate(0deg); } /* [cite: 36] */
      to { transform: translate(-50%, -50%) rotate(360deg); } /* [cite: 36] */
    }
    /* Augmented Reality Styled Labels */
    .ar-label {
      position: absolute; /* [cite: 37] */
      color: var(--secondary); /* [cite: 37] */
      font-size: 0.7rem; /* [cite: 37] */
      letter-spacing: 0.05em; /* [cite: 37] */
      pointer-events: none; /* [cite: 37] */
      z-index: 5; /* [cite: 38] */
      transition: opacity 0.5s; /* [cite: 38] */
      opacity: 0; /* [cite: 38] */
      text-shadow: 0 0 5px var(--secondary); /* [cite: 38] */
    }
    .ar-label::after {
      content: ''; /* [cite: 38] */
      position: absolute; /* [cite: 38] */
      top: 50%; /* [cite: 39] */
      width: 30px; /* [cite: 39] */
      height: 1px; /* [cite: 39] */
      background-color: var(--secondary); /* [cite: 39] */
      opacity: 0.5; /* [cite: 39] */
    }
    .ar-label-left {
      text-align: right; /* [cite: 39] */
    }
    .ar-label-left::after {
      right: -35px; /* [cite: 39] */
    }
    .ar-label-right {
      text-align: left; /* [cite: 40] */
    }
    .ar-label-right::after {
      left: -35px; /* [cite: 40] */
    }
    .info-card {
      opacity: 0; /* [cite: 40] */
      transform: translateY(20px); /* [cite: 40] */
      transition: opacity 0.5s, transform 0.5s; /* [cite: 41] */
    }
    .info-card.show {
      opacity: 1; /* [cite: 41] */
      transform: translateY(0); /* [cite: 41] */
    }
    /* Responsive Styles */
    @media (max-width: 768px) {
      .flex-col-reverse { flex-direction: column-reverse; } /* [cite: 42] */
      #info-panel {
        width: 100%; /* [cite: 42] */
        height: 40%; /* [cite: 42] */
        min-height: 250px; /* [cite: 43] */
        max-height: 50%; /* [cite: 43] */
      }
      #canvas-container {
        height: 60%; /* [cite: 43] */
      }
      .panel-toggle {
        display: block !important; /* [cite: 43] */
      }
      #info-panel.collapsed {
        transform: translateY(calc(100% - 40px)); /* [cite: 44] */
      }
      #toggle-panel-icon {
        transform: rotate(0deg); /* [cite: 44] */
        transition: transform 0.3s; /* [cite: 44] */
      }
      #info-panel.collapsed #toggle-panel-icon {
        transform: rotate(180deg); /* [cite: 45] */
      }
    }
    /* Additional styles for assessment tests */
    .test-panel {
      max-width: 100%; /* [cite: 45] */
      height: 100%; /* [cite: 46] */
      overflow-y: auto; /* [cite: 46] */
      padding: 1rem; /* [cite: 46] */
    }

    .blink-animation {
      animation: blink 1.5s infinite; /* [cite: 46] */
    }

    @keyframes blink {
      0% { opacity: 0.3; } /* [cite: 47] */
      50% { opacity: 1; } /* [cite: 47] */
      100% { opacity: 0.3; } /* [cite: 47] */
    }

    .pulse-animation {
      animation: pulse 2s infinite; /* [cite: 48] */
    }

    @keyframes pulse {
      0% { transform: scale(1); } /* [cite: 48] */
      50% { transform: scale(1.05); } /* [cite: 49] */
      100% { transform: scale(1); } /* [cite: 49] */
    }

    .glow {
      box-shadow: 0 0 15px white; /* [cite: 49] */
      animation: glow 1.5s infinite alternate; /* [cite: 50] */
    }

    @keyframes glow {
      from { box-shadow: 0 0 5px rgba(59, 130, 246, 0.6); } /* [cite: 50] */
      to { box-shadow: 0 0 20px rgba(59, 130, 246, 0.9); } /* [cite: 51] */
    }

    /* REMOVED: Logo container styling */
    /* #logo-container { ... } */
  </style>
</head>
<body>
  <div id="loading-overlay">
    <h2 class="text-4xl font-bold text-center mb-2 glow-text">BIOCARE ASSESSMENT SYSTEM</h2> <p class="text-blue-400 mb-2">Biometric scanning in progress...</p> <p class="text-gray-400 mb-6">Please remain still while we analyze your health parameters</p> <div class="progress-bar"> <div class="progress-fill" id="progress-bar"></div> </div>
    <p id="loading-text" class="mt-4 text-sm text-gray-300 blink-animation">Initializing bioscan...</p> </div>

  <div class="flex h-screen md:flex-row flex-col-reverse">
    <div id="info-panel" class="relative">
      <button id="panel-toggle" class="panel-toggle hidden absolute top-4 right-4 md:hidden bg-gray-700 p-2 rounded-md hover:bg-gray-600 focus:outline-none">
        <svg id="toggle-panel-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /> </svg>
      </button>
      <div class="p-6">
        <div class="sci-title pl-6 mb-4">
          <h1 class="text-2xl font-bold">BioCare Assessment System</h1> <p class="text-sm text-gray-400">Personalized Health Diagnostics</p> </div>
        <div class="flex items-center space-x-2 mb-4">
          <div class="sci-badge bg-blue-700 text-blue-50">
            <span class="opacity-60">BIO</span><span>METRICS</span> </div>
          <div class="h-2 w-2 rounded-full bg-green-400 animate-pulse"></div> <div class="text-xs text-green-400">ASSESSMENT ACTIVE</div> </div>
      </div>
      <div id="test-container" class="px-6 pb-6">
        </div>
    </div>

    <div id="canvas-container" class="relative">
      <div class="hud-element body-stat sci-panel">
        <div class="text-xs text-blue-300 mb-1">DIAGNOSTIC STATUS</div> <div class="text-xs">
          <span>SYSTEM</span>: <span id="system-status" class="text-green-400">STANDBY</span> </div>
        <div class="text-xs">
          <span>RECOMMENDED TESTS</span>: <span class="text-yellow-400">5</span> </div>
      </div>
      <div class="body-scan-line"></div> <div id="body-tracker" class="tracker"></div> <div id="head-label" class="ar-label ar-label-left">COGNITIVE ASSESSMENT</div> <div id="torso-label" class="ar-label ar-label-right">CARDIOVASCULAR TEST</div> <div id="arm-label" class="ar-label ar-label-left">REACTION ASSESSMENT</div> <div id="leg-label" class="ar-label ar-label-right">STABILITY ASSESSMENT</div> <div id="abdomen-label" class="ar-label ar-label-right">BODY COMPOSITION</div> <div id="controls-guide" class="sci-panel">
        <div class="text-xs text-blue-300 mb-1 font-semibold">INTERFACE CONTROLS</div> <div class="grid grid-cols-2 gap-x-3 gap-y-1 text-xs">
          <span>ROTATE VIEW</span><span class="text-gray-300">Left Mouse / Drag</span> <span>ZOOM</span><span class="text-gray-300">Mouse Wheel</span> <span>PAN</span><span class="text-gray-300">Right Mouse / Drag</span> <span>RESET VIEW</span><span class="text-gray-300">Double Click</span> <span>SELECT TEST</span><span class="text-gray-300">Click Body Area</span> </div>
      </div>
    </div>
  </div>

  <audio id="sound-click" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-modern-technology-select-3124.mp3" type="audio/mpeg"> </audio>
  <audio id="sound-hover" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-interface-hint-notification-911.mp3" type="audio/mpeg"> </audio>
  <audio id="sound-scan" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-sci-fi-interface-zoom-890.mp3" type="audio/mpeg"> </audio>

  <script type="text/babel">
    // Component to manage which test is shown
    const TestManager = () => {
      const [activeTest, setActiveTest] = React.useState(null); // [cite: 56]
      // Function to be exposed globally
      window.loadTest = (testId) => { // [cite: 57]
        setActiveTest(testId); // [cite: 57]
      };
      
      // Render the appropriate test component based on the active test
      const renderTest = () => { // [cite: 58]
        switch(activeTest) {
          case 'head': return <CognitiveTest />; // [cite: 58]
          case 'chest': return <CardiovascularTest />; // [cite: 59]
          case 'abdomen': return <BodyCompositionTest />; // [cite: 59]
          case 'leftArm': 
          case 'rightArm': return <ReactionTest />; // [cite: 59]
          case 'leftLeg':
          case 'rightLeg': return <StabilityTest />; // [cite: 60]
          default: return <WelcomeScreen />; // [cite: 60]
        }
      };
      
      return (
        <div className="test-panel">
          {renderTest()}
        </div>
      ); // [cite: 60]
    };

    // Welcome screen shown initially with personalized message
    const WelcomeScreen = () => ( // [cite: 61]
      <div className="sci-panel p-6 info-card show text-gray-200">
        <h2 className="text-xl font-bold mb-4 text-blue-400">Bioscan Complete</h2> <p className="mb-4">
          Our advanced AI diagnostic system has completed your biometric scan and identified specific areas that require assessment to evaluate your overall health status. </p>
  
        
        <p className="mb-4">
          Based on your unique physical profile, we've customized a series of non-invasive diagnostic tests to measure your physiological and cognitive functions. These assessments will provide valuable data about your current health condition. </p>
        
        <div className="my-5 p-4 bg-blue-900 bg-opacity-30 rounded-lg border border-blue-700">
          <h3 className="font-medium text-lg mb-2 text-blue-300">Required Assessments:</h3> <ul className="space-y-2">
            <li className="flex items-start">
              <span className="text-blue-400 mr-2">•</span> <div>
                <span className="font-medium text-blue-300">Cognitive Assessment</span> <p className="text-sm text-gray-400">Analysis indicates potential for memory optimization</p> </div>
            </li>
            <li className="flex items-start">
              <span className="text-blue-400 mr-2">•</span> <div>
                <span className="font-medium text-blue-300">Cardiovascular Test</span> <p className="text-sm text-gray-400">Heart rate patterns require further evaluation</p> </div>
            </li>
            <li className="flex items-start">
              <span className="text-blue-400 mr-2">•</span> <div>
                <span className="font-medium text-blue-300">Body Composition</span> <p className="text-sm text-gray-400">Tissue density scanning indicates BMI assessment needed</p> </div>
            </li>
            <li className="flex items-start">
              <span className="text-blue-400 mr-2">•</span> <div>
                <span className="font-medium text-blue-300">Reaction Assessment</span> <p className="text-sm text-gray-400">Neural pathway response measurement recommended</p> </div>
            </li>
            <li className="flex items-start">
              <span className="text-blue-400 mr-2">•</span> <div>
                <span className="font-medium text-blue-300">Stability Assessment</span> <p className="text-sm text-gray-400">Vestibular system calibration check suggested</p> </div>
            </li>
          </ul>
        </div>
        
        <p className="mb-2">
          Please select any highlighted area on your biometric model to begin the corresponding assessment. Your results will be analyzed to create a comprehensive health profile. </p>
        
        <p className="text-xs text-gray-400 mt-4">
          <strong>Note:</strong> This medical assessment system is for educational and demonstration purposes only. For accurate health diagnostics, please consult licensed healthcare professionals. </p>
      </div>
    );

    // --- PLACEHOLDER REACT COMPONENTS (Keep your actual components here) ---
    const CognitiveTest = () => <div>Cognitive Test Component</div>; // [cite: 67, 81] - Simplified example
    const CardiovascularTest = () => <div>Cardiovascular Test Component</div>; // [cite: 86, 113] - Simplified example
    const BodyCompositionTest = () => <div>Body Composition Test Component</div>;
    const ReactionTest = () => <div>Reaction Test Component</div>;
    const StabilityTest = () => <div>Stability Test Component</div>;
    // --- END PLACEHOLDER COMPONENTS ---

    ReactDOM.render(<TestManager />, document.getElementById('test-container'));

  </script>

  <script>
    // --- Global Variables ---
    let scene, camera, renderer, model, controls, composer;
    let raycaster = new THREE.Raycaster();
    let mouse = new THREE.Vector2();
    let INTERSECTED;
    let bodyParts = {}; // To store interactable body parts
    let arLabels = {}; // To store AR label elements
    let labelPositions = {}; // To store 3D positions for labels
    let trackerElement;
    let canvasContainer;
    let loadingManager;
    let progressBar;
    let loadingText;
    let ambientLight, hemiLight, dirLight;
    let bloomPass;
    let soundClick, soundHover, soundScan;
    let windowHalfX = window.innerWidth / 2;
    let windowHalfY = window.innerHeight / 2;
    let currentIntersectedPart = null; // Track hovered part
    let selectedPart = null; // Track clicked part

    // *** ADDED: Variable to hold the loaded logo model ***
    let myLogoModel = null;


    // --- Initialization ---
    function init() {
      canvasContainer = document.getElementById('canvas-container');
      progressBar = document.getElementById('progress-bar');
      loadingText = document.getElementById('loading-text');
      trackerElement = document.getElementById('body-tracker');
      soundClick = document.getElementById('sound-click');
      soundHover = document.getElementById('sound-hover');
      soundScan = document.getElementById('sound-scan');

      // Loading Manager
      setupLoadingManager();

      // Scene
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1e293b); // Match dark-bg

      // Camera
      camera = new THREE.PerspectiveCamera(45, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 100);
      camera.position.set(0, 1, 5);

      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      canvasContainer.appendChild(renderer.domElement);

      // Lights
      setupLights();

      // Controls
      setupControls();

      // Post-processing
      setupPostProcessing();

      // Load Model
      loadMainModel();

      // Load AR Labels
      loadARLabels();

      // Event Listeners
      setupEventListeners();

      // Start Animation
      animate();
    }

    // --- Setup Functions ---
    function setupLoadingManager() {
      loadingManager = new THREE.LoadingManager();
      const loadingOverlay = document.getElementById('loading-overlay');

      loadingManager.onStart = function (url, itemsLoaded, itemsTotal) {
        loadingText.textContent = 'Initializing bioscan...';
      };

      loadingManager.onLoad = function () {
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
          loadingOverlay.style.display = 'none';
          // Fade in labels after load
          Object.values(arLabels).forEach(el => el.style.opacity = '0.7');
          document.getElementById('system-status').textContent = 'ONLINE';
          document.getElementById('system-status').classList.remove('text-yellow-400');
          document.getElementById('system-status').classList.add('text-green-400');
        }, 500); // Delay hiding to allow fade out
        playScanSound(); // Play sound on load complete
      };

      loadingManager.onProgress = function (url, itemsLoaded, itemsTotal) {
        const progress = (itemsLoaded / itemsTotal) * 100;
        progressBar.style.width = progress + '%';
        loadingText.textContent = `Analyzing biometric data... ${Math.round(progress)}%`;
      };

      loadingManager.onError = function (url) {
        console.error('There was an error loading ' + url);
        loadingText.textContent = 'Error initializing system. Please refresh.';
      };
    }

    function setupLights() {
      ambientLight = new THREE.AmbientLight(0xffffff, 0.3); // Soft ambient light
      scene.add(ambientLight);

      hemiLight = new THREE.HemisphereLight(0xadd8e6, 0x404040, 0.6); // Light blue sky, brown ground
      scene.add(hemiLight);

      dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
      dirLight.position.set(5, 10, 7.5);
      dirLight.castShadow = true;
      dirLight.shadow.mapSize.width = 1024;
      dirLight.shadow.mapSize.height = 1024;
      dirLight.shadow.camera.near = 0.5;
      dirLight.shadow.camera.far = 50;
      dirLight.shadow.camera.left = -10;
      dirLight.shadow.camera.right = 10;
      dirLight.shadow.camera.top = 10;
      dirLight.shadow.camera.bottom = -10;
      scene.add(dirLight);

      const dirLightHelper = new THREE.DirectionalLightHelper(dirLight, 1);
      // scene.add(dirLightHelper); // Uncomment for debugging
      const shadowCameraHelper = new THREE.CameraHelper(dirLight.shadow.camera);
      // scene.add(shadowCameraHelper); // Uncomment for debugging
    }

    function setupControls() {
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.1;
      controls.screenSpacePanning = false;
      controls.minDistance = 2;
      controls.maxDistance = 15;
      controls.target.set(0, 0.9, 0); // Center around the model's torso
      controls.maxPolarAngle = Math.PI / 1.8; // Prevent looking directly from top/bottom
      controls.minPolarAngle = Math.PI / 4; // Prevent looking from too low
      controls.update();
    }

    function setupPostProcessing() {
      composer = new THREE.EffectComposer(renderer);
      const renderPass = new THREE.RenderPass(scene, camera);
      composer.addPass(renderPass);

      // Bloom pass (for glow effect)
      bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.3, 0.85); // Adjust parameters for desired glow
      // bloomPass.threshold = 0;
      // bloomPass.strength = 0.6; // Glow intensity
      // bloomPass.radius = 0.4;   // Glow radius
      composer.addPass(bloomPass);

      // FXAA Pass (Antialiasing)
      const fxaaPass = new THREE.ShaderPass(THREE.FXAAShader);
      fxaaPass.material.uniforms['resolution'].value.x = 1 / (canvasContainer.clientWidth * renderer.getPixelRatio());
      fxaaPass.material.uniforms['resolution'].value.y = 1 / (canvasContainer.clientHeight * renderer.getPixelRatio());
      composer.addPass(fxaaPass);
    }

    function loadMainModel() {
      const dracoLoader = new THREE.DRACOLoader();
      dracoLoader.setDecoderPath('https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/draco/gltf/'); // Adjust path if needed

      const loader = new THREE.GLTFLoader(loadingManager);
      loader.setDRACOLoader(dracoLoader);

      loader.load(
        //'https://raw.githubusercontent.com/riccardouz/figma-plugin-human/master/static/Human.glb', // Original path
        'https://raw.githubusercontent.com/GanyuHail/humanglbfiles/main/human.glb', // Using a different source due to CORS issues
        function (gltf) {
          model = gltf.scene;
          model.scale.set(1.0, 1.0, 1.0); // Adjust scale if needed
          model.position.y = -1; // Adjust position to center vertically

          // Apply materials and enable shadows
          model.traverse(function (node) {
            if (node.isMesh) {
              node.castShadow = true;
              node.receiveShadow = true;
              // Optional: Customize material properties
              if (node.material) {
                node.material.metalness = 0.1;
                node.material.roughness = 0.8;
              }
            }
          });

          scene.add(model);
          console.log("Main model loaded.");

          // Identify body parts and calculate label positions
          setupBodyPartInteraction();
          calculateLabelPositions();


          // *** ADDED: Load the logo model AFTER the main model ***
          const logoLoader = new THREE.GLTFLoader(loadingManager); // Use the same manager
          logoLoader.load(
              'logo.glb', // <<< MAKE SURE THIS PATH IS CORRECT!
              function (logoGltf) {
                  myLogoModel = logoGltf.scene;

                  // --- POSITION AND SCALE THE LOGO ---
                  // You MUST adjust these values to place the logo correctly.
                  // Option 1: Position relative to scene origin
                  // myLogoModel.scale.set(0.1, 0.1, 0.1); // Example scale (adjust!)
                  // myLogoModel.position.set(2, 1.5, -3); // Example position (adjust!)

                  // Option 2: Attach to Camera (keeps logo fixed in view) - Often better for UI elements
                  camera.add(myLogoModel); // Add logo as child of camera
                  myLogoModel.scale.set(0.05, 0.05, 0.05); // Adjust scale relative to camera view
                  // Position relative TO the camera (X: right, Y: up, Z: towards viewer)
                  myLogoModel.position.set(1.5, 1, -3); // Example: Top-right corner (adjust!)


                  // Add subtle lighting if needed for the logo specifically
                  // (or ensure main scene lights affect it if not attached to camera)
                  // const logoLight = new THREE.PointLight(0xffffff, 0.5);
                  // logoLight.position.set(0, 1, 0); // Relative to logo
                  // myLogoModel.add(logoLight);

                  // If NOT attaching to camera, add to the main scene:
                  // scene.add(myLogoModel);

                  console.log("Logo loaded and added.");
              },
              undefined, // Progress callback (optional)
              function (error) {
                  console.error('Error loading logo:', error);
              }
          );
          // *** END LOGO LOADING ***

        },
        undefined, // onProgress is handled by the LoadingManager
        function (error) {
          console.error('An error happened loading the main model:', error);
          loadingText.textContent = 'Error loading model data.';
        }
      );
    }

    // REMOVED: function initLogo3D() { ... }


    function loadARLabels() {
      arLabels = {
        head: document.getElementById('head-label'),
        torso: document.getElementById('torso-label'),
        arm: document.getElementById('arm-label'),
        leg: document.getElementById('leg-label'),
        abdomen: document.getElementById('abdomen-label'),
      };
    }

    function setupBodyPartInteraction() {
      if (!model) return;
      // Find specific meshes by name (adjust names based on your GLB model structure)
      bodyParts = {
        head: model.getObjectByName('Head'),       // Example name, adjust!
        chest: model.getObjectByName('Spine2'),   // Example name, adjust!
        leftArm: model.getObjectByName('LeftArm'),  // Example name, adjust!
        rightArm: model.getObjectByName('RightArm'),// Example name, adjust!
        abdomen: model.getObjectByName('Spine'),    // Example name, adjust!
        leftLeg: model.getObjectByName('LeftUpLeg'), // Example name, adjust!
        rightLeg: model.getObjectByName('RightUpLeg')// Example name, adjust!
      };

      // Filter out any parts not found
      bodyParts = Object.fromEntries(Object.entries(bodyParts).filter(([_, value]) => value));

      console.log("Identified body parts for interaction:", Object.keys(bodyParts));
    }

    function calculateLabelPositions() {
      if (!model) return;
      // Define approximate 3D positions relative to the model's origin for labels
      // Adjust these vectors based on your model's scale and orientation
      labelPositions = {
        head: new THREE.Vector3(0, 1.7, 0.3),    // Top of head area
        torso: new THREE.Vector3(0.4, 1.1, 0.2),   // Chest area (right side)
        arm: new THREE.Vector3(-0.6, 1.2, 0.1),  // Left arm area
        leg: new THREE.Vector3(0.3, 0.2, 0.3),   // Right leg area
        abdomen: new THREE.Vector3(0.3, 0.8, 0.3) // Abdomen area (right side)
      };
    }


    function setupEventListeners() {
      window.addEventListener('resize', onWindowResize, false);
      canvasContainer.addEventListener('mousemove', onMouseMove, false);
      canvasContainer.addEventListener('click', onClick, false);
      canvasContainer.addEventListener('dblclick', onDoubleClick, false);

      // Mobile Panel Toggle
      const panelToggle = document.getElementById('panel-toggle');
      const infoPanel = document.getElementById('info-panel');
      if (panelToggle && infoPanel) {
        panelToggle.addEventListener('click', () => {
          infoPanel.classList.toggle('collapsed');
        });
      }
    }


    // --- Event Handlers ---
    function onWindowResize() {
      windowHalfX = window.innerWidth / 2;
      windowHalfY = window.innerHeight / 2;

      camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight;
      camera.updateProjectionMatrix();

      renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
      composer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);

      // Update FXAA resolution
      const fxaaPass = composer.passes.find(pass => pass.shader === THREE.FXAAShader);
      if (fxaaPass) {
        fxaaPass.material.uniforms['resolution'].value.x = 1 / (canvasContainer.clientWidth * renderer.getPixelRatio());
        fxaaPass.material.uniforms['resolution'].value.y = 1 / (canvasContainer.clientHeight * renderer.getPixelRatio());
      }

      // Update Bloom resolution if needed (might already handle it internally)
      // bloomPass.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
    }

    function onMouseMove(event) {
      // Calculate mouse position in normalized device coordinates (-1 to +1)
      const rect = canvasContainer.getBoundingClientRect();
      mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

      // Update tracker position immediately
      trackerElement.style.left = (event.clientX - rect.left) + 'px';
      trackerElement.style.top = (event.clientY - rect.top) + 'px';
      trackerElement.style.opacity = '1'; // Show tracker on move
    }


    function onClick(event) {
      event.preventDefault();

      if (currentIntersectedPart && currentIntersectedPart.partName) {
        // Highlight clicked part visually (e.g., change color or add outline) - requires material manipulation
        console.log(`Clicked on: ${currentIntersectedPart.partName}`);
        selectedPart = currentIntersectedPart.partName;

        // Trigger React component update
        if (window.loadTest) {
          window.loadTest(selectedPart); // Pass the part name to React
        }
        playClickSound();

        // Optional: Focus camera on the selected part
        // focusCameraOnPart(currentIntersectedPart.object);
      }
    }

    function onDoubleClick() {
        // Reset camera and controls to initial state
        controls.reset();
        camera.position.set(0, 1, 5);
        controls.target.set(0, 0.9, 0);
        controls.update();
        console.log("View Reset");
    }


    // --- Core Logic ---
    function checkIntersection() {
      if (!model) return;

      raycaster.setFromCamera(mouse, camera);

      const intersects = raycaster.intersectObject(model, true); // Check recursively

      if (intersects.length > 0) {
        const intersectedObject = intersects[0].object;

        // Find which named body part this intersected mesh belongs to
        let partName = null;
        for (const [name, part] of Object.entries(bodyParts)) {
          if (part && (intersectedObject === part || intersectedObject.parent === part || intersectedObject.parent?.parent === part)) { // Check object and its parents
            partName = name;
            break;
          }
        }

        if (partName && partName !== currentIntersectedPart?.partName) {
          // New part hovered
          if (currentIntersectedPart) {
            // Optional: Restore previous part's appearance if changed
          }
          currentIntersectedPart = { object: intersectedObject, partName: partName };
          // Optional: Highlight current part
          playHoverSound();
          canvasContainer.style.cursor = 'pointer';

          // Show tracker positioned over the intersection point
           const vector = intersects[0].point.clone().project(camera);
           const x = (vector.x * 0.5 + 0.5) * canvasContainer.clientWidth;
           const y = (-(vector.y * 0.5) + 0.5) * canvasContainer.clientHeight;
           trackerElement.style.left = x + 'px';
           trackerElement.style.top = y + 'px';
           trackerElement.style.opacity = '1';

        } else if (!partName && currentIntersectedPart) {
           // Mouse moved off a recognized part
           canvasContainer.style.cursor = 'grab';
           // Optional: Restore previous part's appearance
           currentIntersectedPart = null;
           trackerElement.style.opacity = '0'; // Hide tracker when not over a part
        }

      } else {
        // Not intersecting the model
        if (currentIntersectedPart) {
          // Optional: Restore previous part's appearance
          canvasContainer.style.cursor = 'grab';
          currentIntersectedPart = null;
          trackerElement.style.opacity = '0'; // Hide tracker
        }
      }
    }


    function updateARLabels() {
        if (!model || !canvasContainer || !camera) return;

        for (const label in arLabels) {
            const element = arLabels[label];
            if (element && labelPositions[label]) {
                // Get the world position for the label anchor point
                const position = labelPositions[label].clone();
                // No need to add model position if labelPositions are already in world space
                // If labelPositions are relative to model, uncomment below:
                // position.applyMatrix4(model.matrixWorld); // Ensure position is in world space

                // Project the 3D point to 2D screen coordinates
                const vector = position.project(camera);

                // Convert normalized device coordinates to pixel coordinates
                const x = (vector.x * 0.5 + 0.5) * canvasContainer.clientWidth;
                const y = (-(vector.y * 0.5) + 0.5) * canvasContainer.clientHeight;

                // Position the HTML element, offsetting based on alignment class
                let offset = element.offsetWidth / 2; // Default center
                if (element.classList.contains('ar-label-left')) {
                    offset = element.offsetWidth + 10; // Offset for right-aligned text + line
                     element.style.left = (x - offset) + 'px';
                } else if (element.classList.contains('ar-label-right')) {
                     offset = -10; // Offset for left-aligned text + line
                     element.style.left = (x + offset) + 'px';
                } else {
                     element.style.left = (x - offset) + 'px'; // Centered default
                }

                element.style.top = (y - element.offsetHeight / 2) + 'px'; // Center vertically

                // Hide label if it's behind the camera
                element.style.opacity = vector.z < 1 ? '0.7' : '0'; // Use opacity for fade effect
            }
        }
    }

    // --- Audio ---
    function playClickSound() {
      if (soundClick) {
        soundClick.currentTime = 0;
        soundClick.play().catch(e => console.log("Audio play failed:", e));
      }
    }
    function playHoverSound() {
       if (soundHover) {
        soundHover.currentTime = 0;
        soundHover.volume = 0.3; // Lower volume for hover
        soundHover.play().catch(e => console.log("Audio play failed:", e));
      }
    }
    function playScanSound() {
       if (soundScan) {
        soundScan.currentTime = 0;
        soundScan.play().catch(e => console.log("Audio play failed:", e));
      }
    }

    // --- Animation Loop ---
    function animate() {
      requestAnimationFrame(animate);

      // Update controls
      if (controls) {
        controls.update();
      }

      // Check for intersections on mouse move (can optimize by doing less frequently)
      checkIntersection();

      // Update AR label positions
      updateARLabels();

      // *** ADDED: Animate the logo (e.g., simple rotation) ***
      if (myLogoModel) {
          myLogoModel.rotation.y += 0.01; // Adjust rotation speed/axis as needed
          // Add other logo animations here if desired
      }

      // Render scene with post-processing
      if (composer && scene && camera) {
        composer.render(); // Renders the main scene (including the logo if added to it)
      }

      // REMOVED: Separate logo rendering block
      // if (window.logoRenderer && window.logoScene && window.logoCamera) { ... }
    }


    // --- Start ---
    // Add DOMContentLoaded listener to ensure HTML is ready
    document.addEventListener('DOMContentLoaded', init);

  </script>
</body>
</html>
